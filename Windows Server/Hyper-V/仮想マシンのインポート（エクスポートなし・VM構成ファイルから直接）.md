# 仮想マシンのインポート（エクスポートなし・VM構成ファイルから直接）

## 概要

- Windows Server 2012より、事前にエクスポートしないで、VM構成ファイルから直接インポート出来るようになった。
- 例えば、Hyper-Vサーバに障害が発生した場合、仮想マシンのVM構成ファイルを別のHyper-Vサーバにコピーして、それをインポートすれば、仮想マシンを復旧出来る。
- 注意点として、同一のHyper-Vサーバ上で、すでに登録済みの仮想マシンをコピーして登録する事は出来ない。そのような場合、すでに登録済みの仮想マシンをエクスポートして、それを新規の仮想マシンとして登録する事になる。

## 準備

- インポート元の仮想マシンはシャットダウンしておく。
- 起動している状態でもインポート出来なくはないが、強制シャットダウンの状態になる。
- 仮想マシンファイルのコピーや移動をする際にエクスプローラーから警告が出る場合は、管理ツールを使い、Hyper-Vサービスを停止する。

## 手順

### 0. 作業の開始

- Hyper-Vマネージャを起動して、右ペインから[仮想マシンのインポート]を選ぶ。

### 1. フォルダーの検索

- インポートする仮想マシンを含むフォルダーを指定してください。
- 通常、Virtual Machinesというフォルダー名のフォルダー以下に、仮想マシンID（16進数32文字）.xmlというファイルがある。Virtual Machinesフォルダーか、その上のフォルダーを指定する。

### 2. 仮想マシンの選択

- 上で選んだフォルダー以下に見つかった仮想マシンが列挙されるので、選択する。

### 3. インポートの種類

- 「仮想マシンをインプレースで登録する」「仮想マシンを復元する」「仮想マシンをコピーする」が選べる。
- 前者2つは同じHyper-Vサーバ内からはインポート出来ない。（IDを重複させて、同時に2つの仮想マシンを登録出来ない。）後者はIDを新規に作成して、インポートする。

### 4. 移動先の選択

- デフォルト： C:\ProgramData\Microsoft\Windows\Hyper-V 
- 「仮想マシンの構成フォルダー」「チェックポイントストア」「スマートページフォルダー」を指定する。
- ここで「仮想マシンの構成フォルダー」「チェックポイントストア」「スマートページフォルダー」をC:\Hyper-V\Win10と指定すると、インポート完了後は以下のような構成になる。
  - C:\Hyper-V\Win10\Virtual Machines\仮想マシンID.xml
  - C:\Hyper-V\Win10\Virtual Machines\仮想マシンIDフォルダー
- 基本的にHyper-V用のフォルダー（C:\Hyper-V）を作り、その下に仮想マシンごとのフォルダー（C:\Hyper-V\Win10）を作り、それをここで指定すると良いと思う。仮想マシンIDは分りづらい文字列なので、自分で分りやすいフォルダー名のフォルダーを作った方が良い。

### 5. 仮想ハードディスクを保存するフォルダーを選択します。

- デフォルト： C:\Users\Public\Documents\Hyper-V\Virtual Hard Disks\
- このフォルダーの下にVHDXファイルが出来。
- 4.の例のように、C:\Hyper-V\Win10\Virtual Hard Disksというフォルダーを作り、それを指定すると良いだろう。

### 6. インポートの実行

- 20GB程度のWindowsでインポートに1分くらい掛かるようだ。

## 注意点

- インポート後に起動に失敗する場合は、仮想マシンの設定を確認する。（削除されたISOファイルをDVDドライブに指定しいないか？など）

## 参考
http://www.atmarkit.co.jp/ait/articles/1309/06/news097.html
